(function(){tinymce.create("org.olat.ims.qti21.ui.editor",{getInfo:function(){return{longname:"OpenOLATQTI",author:"frentix GmbH",authorurl:"http://www.frentix.com",infourl:"http://www.frentix.com",version:"1.1.0"}},createControl:function(b,a){return null},init:function(e,d){var c=e.$,r=e.selection;var s,p;var g;var l;function o(){if(s){return s}var t=o_getMainWin();if(t){s=jQuery(document).ooTranslator().getTranslator(t.o_info.locale,"org.olat.ims.qti21.ui.editor")}else{s={translate:function(u){return u}}}return s}function b(){if(p){return p}var t=o_getMainWin();if(t){p=jQuery(document).ooTranslator().getTranslator(t.o_info.locale,"org.olat.core")}else{p={translate:function(u){return u}}}return p}function j(t){i(t,"string")}function n(t){i(t,"float")}function i(w,z){var u=false;var x=null;var B;if(typeof l!="undefined"){B=jQuery(l).attr("data-qti-response-identifier")}else{var t=1;x=e.selection.getContent({format:"text"});tinymce.each(e.dom.select("img[data-qti]"),function(D){var C=jQuery(D).attr("data-qti-response-identifier");if(C.lastIndexOf("RESPONSE_",0)==0){var E=parseInt(C.substring(9,C.length));if(E>t){t=E}}});var B="RESPONSE_"+(t+1);var y=f(B,"textentryinteraction",z);var v=new tinymce.html.Serializer().serialize(y);e.insertContent(v);u=true}var A=e.getParam("ffxhrevent");o_ffXHREvent(A.formNam,A.dispIdField,A.dispId,A.eventIdField,2,false,false,false,"cmd","gapentry","responseIdentifier",B,"newEntry",u,"selectedText",x,"gapType",z)}function m(){function t(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return t()+t()+t()+t()+t()+t()+t()}function a(x){var B;if(typeof l!="undefined"){B=jQuery(l).data("data-identifier")}else{var t=1;var u=e.selection.getContent({format:"text"});var A=false;if(u==null||u.length==0){u="text";A=true}var y="ht"+m();var z=q(y,u,false,"hottext");var v=new tinymce.html.Serializer().serialize(z);e.insertContent(v);if(A){var w=e.dom.select("span[data-qti-identifier="+y+"] span[contenteditable=true]");e.selection.select(w[0],true)}}}e.addButton("olatqtifibtext",{title:o().translate("new.fib"),icon:"gaptext",stateSelector:["img[data-qti-gap-type=string]","span[data-qti-gap-type=string]"],onclick:j});e.addButton("olatqtifibnumerical",{title:o().translate("new.fib")+" Numerical",icon:"gapnumerical",stateSelector:["img[data-qti-gap-type=float]","span[data-qti-gap-type=float]"],onclick:n});e.addButton("olatqtihottext",{title:o().translate("new.hottext"),icon:"hottext",stateSelector:["span[data-qti=hottext]"],onclick:a});e.addButton("editgap",{title:"edit",icon:"edit",onclick:i});e.addMenuItem("olatqtifibtext",{text:o().translate("new.fib"),icon:"gapnumerical",stateSelector:["img[data-qti-gap-type=string]","span[data-qti-gap-type=string]"],onclick:n});e.addMenuItem("olatqtifibnumerical",{text:o().translate("new.fib.numerical")+" Numerical",icon:"gaptext",stateSelector:["img[data-qti-gap-type=float]","span[data-qti-gap-type=float]"],onclick:j});e.addMenuItem("olatqtihottext",{text:o().translate("new.hottext"),icon:"hottext",stateSelector:["span[data-qti=hottext]"],onclick:a});e.on("NodeChange",function(t){if(l&&l.id!=t.element.src){l=undefined}if(h(t.element)){l=t.element}});function h(t){return e.dom.is(t,"img[data-qti]")}function f(v,u,t){var w=new tinymce.html.Node("img",1);w.attr({width:"32",height:"16",src:tinymce.Env.transparentSrc,"data-qti":u,"data-qti-response-identifier":v,"data-qti-gap-type":t,"data-mce-placeholder":"","data-mce-resize":"false","data-textentryinteraction":"empty","class":"mce-shim "+u});return w}function q(w,x,v,t){var z=new tinymce.html.Node("span",1);z.attr({"data-qti":t,"data-qti-identifier":w,"class":t,contenteditable:"false"});var A=new tinymce.html.Node("input",1);A.attr({contenteditable:"true",name:"hottext",value:w,type:"checkbox"});if(v){A.attr({checked:"checked"})}z.append(A);var u=new tinymce.html.Node("span",1);u.attr({contenteditable:"true"});var y=new tinymce.html.Node("#text",3);y.raw=true;y.value=x;u.append(y);z.append(u);return z}function k(u){var t="";var w=new tinymce.dom.TreeWalker(u);var v;while((v=w.next())){if(v.type==3){if(t.length>0){t+=" "}t+=v.value}else{if(v.nodeType==3){if(t.length>0){t+=" "}t+=v.nodeValue}}}return t}e.on("init",function(){if(e.settings.content_css!==false){e.dom.loadCSS(d+"/css/content.css")}jQuery("img.textentryinteraction",e.getBody()).each(function(t,u){var v=u;jQuery(v).click(function(){var x=e.getParam("ffxhrevent");var w=jQuery(v).attr("data-qti-response-identifier");o_ffXHREvent(x.formNam,x.dispIdField,x.dispId,x.eventIdField,2,false,false,false,"cmd","gapentry","responseIdentifier",w)})});jQuery("span.hottext input",e.getBody()).each(function(t,u){var v=u;jQuery(v).click(function(){var w=e.getParam("ffxhrevent");var x=jQuery(v).parent("span.hottext").data("qti-identifier");o_ffXHRNFEvent(w.formNam,w.dispIdField,w.dispId,w.eventIdField,2,"cmd","hottext","identifier",x,"correct",u.checked);e.setDirty(true)})})});e.on("preInit",function(){e.parser.addNodeFilter("textentryinteraction,hottext",function(t){var w=t.length,u,B,x;while(w--){u=t[w];if(u.name=="textentryinteraction"){var D=u.attr("responseidentifier");var C=u.attr("openolattype");if(typeof C==="undefined"){C="string"}var B=f(D,"textentryinteraction",C);u.replace(B)}else{if(u.name=="hottext"){var A=u.attr("identifier");var v=e.getParam("correctHottexts");var z=jQuery.inArray(A,v)>=0;var y=k(u);var B=q(A,y,z,"hottext","hottext");u.replace(B)}}}})});e.on("PreProcess",function(t){tinymce.each(e.dom.select("img[data-qti=textentryinteraction]"),function(v){var u=jQuery(v).attr("data-qti-response-identifier");var w=e.dom.create("textEntryInteraction",{responseIdentifier:u});e.dom.replace(w,v,false)});tinymce.each(e.dom.select("span[data-qti=hottext]"),function(v){var u=jQuery(v).data("qti-identifier");var w=e.dom.create("hottext",{identifier:u});var x=jQuery('span[contenteditable="true"]',v).html();w.textContent=x;e.dom.replace(w,v,false)})})}});tinymce.PluginManager.add("olatqti",org.olat.ims.qti21.ui.editor)})();